version: "3.8"

services:
  senzor:
    # Official Senzor Agent Image
    image: ghcr.io/senzops/server-agent:latest
    container_name: senzor
    restart: unless-stopped

    # CRITICAL: Network and PID must be 'host' to monitor the actual server
    network_mode: "host"
    pid: "host"

    # Mount host directories strictly Read-Only (:ro) for security
    volumes:
      - /:/host/root:ro
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Configuration
    environment:
      # 1. API Configuration
      # If self-hosting, change this to your backend URL (e.g. http://your-ip:5000/api/ingest/stats)
      - API_ENDPOINT=https://api.senzor.dev/api/ingest/stats

      # 2. Authentication (Get these from your Dashboard)
      - SERVER_ID=REPLACE_WITH_YOUR_SERVER_ID
      - API_KEY=REPLACE_WITH_YOUR_API_KEY

      # 3. Settings
      - INTERVAL=60 # Seconds between checks
      - NODE_ENV=production

      # 4. Integrations (Opt-in)
      # To enable Nginx monitoring, set ENABLE_NGINX to true and provide the status URL
      # Ensure your Nginx is configured with the 'stub_status' module reachable at this URL
      - ENABLE_NGINX=false
      - NGINX_STATUS_URL=http://127.0.0.1/nginx_status

      # 5. Traefik (Opt-in)
      - ENABLE_TRAEFIK=false
      - TRAEFIK_API_URL=http://127.0.0.1:8080 
      # Optional: Only if Traefik dashboard is protected
      # - TRAEFIK_USER=admin
      # - TRAEFIK_PASSWORD=secure_password
      
      #6. Terminal (Opt-in)
      - ENABLE_TERMINAL=false

    # Resource Limits (Safety Guardrails)
    # Ensures the agent never consumes too much of your server's resources
    deploy:
      resources:
        limits:
          memory: 150M
          cpus: "0.10" # Max 10% of 1 CPU Core
        reservations:
          memory: 30M
